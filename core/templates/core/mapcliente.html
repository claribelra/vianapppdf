{% extends 'core/base.html' %}
{% load static %}
{% block title %}Mapa | VianApp{% endblock %}

{% block content %}
<div class="container my-4 position-relative" style="z-index: 2;">
    <div id="ubicacion-actual" style="position: absolute; top: 18px; left: 50%; transform: translateX(-50%); z-index: 10; background: #fff; border-radius: 18px; box-shadow: 0 2px 12px rgba(33,150,243,0.10); padding: 8px 22px; display: none; align-items: center; gap: 10px;">
        <img src="https://cdn-icons-png.flaticon.com/512/64/64113.png" alt="Ubicación" style="width: 28px; height: 28px; vertical-align: middle;">
        <span style="color: #2196f3; font-weight: 700; font-size: 1.08rem;">Tu ubicación actual</span>
    </div>
    <div id="ubicacion-error" style="position: absolute; top: 60px; left: 50%; transform: translateX(-50%); z-index: 10; background: #fff3f3; border-radius: 18px; box-shadow: 0 2px 12px rgba(255,0,0,0.10); padding: 8px 22px; display: none; align-items: center; gap: 10px;">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828665.png" alt="Error" style="width: 24px; height: 24px; vertical-align: middle;">
        <span style="color: #d32f2f; font-weight: 700; font-size: 1.08rem;">No se pudo obtener tu ubicación. Activa los permisos de ubicación en tu navegador.</span>
    </div>
    <div id="map" style="height: 500px; width: 100%; border-radius: 12px; z-index: 1;"></div>

    <div class="buscador-container mt-4 p-4" style="background: #eaf1fb; border-radius: 16px; box-shadow: 0 2px 16px rgba(33,150,243,0.10); max-width: 600px; margin: 32px auto 0 auto; z-index: 2; position: relative; display: flex; flex-direction: column; align-items: stretch;">
        <div class="d-flex flex-row align-items-center justify-content-between flex-wrap" style="gap: 12px;">
            <h2 class="text-center mb-3 mb-md-0" style="color: #2196f3; font-weight: 800; font-size: 2rem; flex: 1;">Encuentra tu parqueadero cercano</h2>
            <button id="center-location-btn" type="button" title="Centrar en mi ubicación" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 54px; height: 54px; background: #2196f3; border-radius: 50%; box-shadow: 0 2px 12px #2196f355; cursor: pointer; border: none; transition: background .2s; margin-left: 8px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" style="display:block;margin:auto;">
                    <circle cx="12" cy="12" r="8" stroke="#fff" stroke-width="2" fill="#2196f3"/>
                    <circle cx="12" cy="12" r="3" fill="#fff"/>
                </svg>
                <span style="font-size:0.85rem;color:#fff;font-weight:500;margin-top:2px;letter-spacing:0.5px;text-shadow:0 1px 4px #2196f355;">Centrar ubicación</span>
            </button>
        </div>
        <div class="row justify-content-center align-items-center">
            <div class="col-12 col-md-7 mb-2">
                <input id="searchInput" type="text" class="form-control" placeholder="Buscar parqueadero por nombre o dirección..." style="border-radius: 8px; border: 1.5px solid #2196f3; font-size: 1.1rem;">
            </div>
            <div class="col-12 col-md-5 mb-2">
                <select id="citySelect" class="form-select" style="border-radius: 8px; border: 1.5px solid #43a047; font-size: 1.1rem;">
                    <option value="">Todas las ciudades</option>
                    <option value="Bogotá">Bogotá</option>
                    <option value="Medellín">Medellín</option>
                    <option value="Cali">Cali</option>
                    <option value="Neiva">Neiva</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine CSS y JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<script>
document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('map').setView([4.7110, -74.0721], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    let routingControl = null;
    let userLatLng = null;
    let watchId = null;

    function iniciarRouting(destLat, destLng) {
        if (routingControl) {
            map.removeControl(routingControl);
        }
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(userLatLng.lat, userLatLng.lng),
                L.latLng(destLat, destLng)
            ],
            routeWhileDragging: false,
            draggableWaypoints: false,
            addWaypoints: false,
            show: false,
            createMarker: function() { return null; },
            lineOptions: { styles: [{color: '#2196f3', weight: 6}] }
        }).addTo(map);

        routingControl.on('routesfound', function(e) {
            var instructionsDiv = document.getElementById('routing-instructions');
            if (!instructionsDiv) {
                instructionsDiv = document.createElement('div');
                instructionsDiv.id = 'routing-instructions';
                instructionsDiv.style = 'max-width:420px;margin:18px auto 0 auto;padding:18px 18px 12px 18px;background:#fff;border-radius:14px;box-shadow:0 2px 12px #2196f322;font-size:1.08rem;color:#222;';
                document.querySelector('.container').appendChild(instructionsDiv);
            }
            var routes = e.routes;
            if (routes.length > 0) {
                var summary = routes[0].summary;
                var html = `<div style='font-weight:700;color:#2196f3;margin-bottom:8px;'>Instrucciones paso a paso</div>`;
                html += `<div style='margin-bottom:8px;'><b>Distancia:</b> ${(summary.totalDistance/1000).toFixed(2)} km &nbsp; <b>Tiempo:</b> ${(summary.totalTime/60).toFixed(0)} min</div>`;
                html += '<ol style="padding-left:18px;">';
                routes[0].instructions.forEach(function(instr) {
                    html += `<li style='margin-bottom:4px;'>${traducirInstruccion(instr.text)}</li>`;
                });
                html += '</ol>';
                instructionsDiv.innerHTML = html;
            }
        });
    }

    // Traducción básica de instrucciones al español
    function traducirInstruccion(text) {
        const diccionario = [
            {en: 'Turn right', es: 'Gira a la derecha'},
            {en: 'Turn left', es: 'Gira a la izquierda'},
            {en: 'Continue', es: 'Continúa'},
            {en: 'Head', es: 'Dirígete'},
            {en: 'Go straight', es: 'Sigue recto'},
            {en: 'Slight right', es: 'Leve giro a la derecha'},
            {en: 'Slight left', es: 'Leve giro a la izquierda'},
            {en: 'Destination', es: 'Destino'},
            {en: 'at the roundabout', es: 'en la rotonda'},
            {en: 'onto', es: 'en'},
            {en: 'toward', es: 'hacia'},
            {en: 'and continue', es: 'y continúa'},
            {en: 'Merge', es: 'Incorpórate'},
            {en: 'Take the', es: 'Toma la'},
            {en: 'Exit', es: 'Salida'},
            {en: 'Keep right', es: 'Mantente a la derecha'},
            {en: 'Keep left', es: 'Mantente a la izquierda'},
            {en: 'U-turn', es: 'Giro en U'},
            {en: 'Sharp right', es: 'Giro pronunciado a la derecha'},
            {en: 'Sharp left', es: 'Giro pronunciado a la izquierda'}
        ];
        let traducido = text;
        diccionario.forEach(function(pair) {
            traducido = traducido.replace(new RegExp(pair.en, 'gi'), pair.es);
        });
        return traducido;
    }

    function actualizarRutaDestino(destLat, destLng) {
        if (routingControl) {
            routingControl.setWaypoints([
                L.latLng(userLatLng.lat, userLatLng.lng),
                L.latLng(destLat, destLng)
            ]);
        }
    }

    // --- Ubicación del usuario ---
    let userMarker = null;
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLatLng = { lat: position.coords.latitude, lng: position.coords.longitude };
            userMarker = L.marker([userLatLng.lat, userLatLng.lng], {
                icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                })
            }).addTo(map)
              .bindPopup('<strong>¡Estás aquí!</strong>').openPopup();
            map.setView([userLatLng.lat, userLatLng.lng], 15);
            document.getElementById('ubicacion-actual').style.display = 'flex';

            // --- Seguimiento en tiempo real ---
            watchId = navigator.geolocation.watchPosition(function(pos) {
                const newLat = pos.coords.latitude;
                const newLng = pos.coords.longitude;
                // Animación suave del marcador
                if (userMarker) {
                    const startLatLng = userMarker.getLatLng();
                    const steps = 20;
                    let step = 0;
                    const latStep = (newLat - startLatLng.lat) / steps;
                    const lngStep = (newLng - startLatLng.lng) / steps;
                    function animateMarker() {
                        if (step < steps) {
                            userMarker.setLatLng([
                                startLatLng.lat + latStep * step,
                                startLatLng.lng + lngStep * step
                            ]);
                            step++;
                            requestAnimationFrame(animateMarker);
                        } else {
                            userMarker.setLatLng([newLat, newLng]);
                        }
                    }
                    animateMarker();
                }
                userLatLng = { lat: newLat, lng: newLng };
                if (routingControl && routingControl._waypoints && routingControl._waypoints[1]) {
                    actualizarRutaDestino(routingControl._waypoints[1].latLng.lat, routingControl._waypoints[1].latLng.lng);
                }
            });
        }, function(error) {
            document.getElementById('ubicacion-error').style.display = 'flex';
            console.error('Error de geolocalización:', error);
        });
    }

    // --- Marcadores de parqueaderos registrados ---
   var markers = [];
   var parqueaderos = [];
   try {
    var jsonString = '{{ parqueaderos_json|safe }}';   // 👈 usa safe en lugar de escapejs
    console.log("JSON bruto desde Django:", jsonString); // 👈 debug 1
    if (jsonString && jsonString !== 'null' && jsonString !== 'undefined') {
        parqueaderos = JSON.parse(jsonString);
        console.log("Parqueaderos parseados:", parqueaderos); // 👈 debug 2
    }
} catch (e) {
    console.error('Error al parsear parqueaderos_json:', e, jsonString);
    parqueaderos = [];
}


    // Debug en consola
    console.log("Parqueaderos cargados:", parqueaderos);

    parqueaderos.forEach(function(p) {
        var lat = parseFloat(p.latitud);
        var lng = parseFloat(p.longitud);
        var ciudad = p.ciudad || '';
        var nombre = p.nombre_comercial || '';
        var direccion = p.direccion || '';
        var tarifaHora = p.tarifa_hora || 'No disponible';
        var cupos = p.espacios || 'No disponible';

        var popupContent = `
            <div style="text-align:center;">
                <img src="${p.foto_parqueadero}" alt="Imagen Parqueadero" style="width:80px;height:60px;object-fit:cover;border-radius:6px;margin-bottom:6px;">
                <br><strong>${nombre}</strong>
                <br><span style="font-size:0.95em;">${direccion}, ${ciudad}</span>
                <br><span style="font-size:0.95em;">Tarifa/hora: $${tarifaHora}</span>
                <br><span style="font-size:0.95em;">Cupos disponibles: ${cupos}</span>
                <div style='display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:10px;'>
                    <a href="/reservarcliente/${p.id}/" class="popup-btn reservar-btn">Reservar cupo</a>
                    <button class="popup-btn llegar-btn" onclick='window.mostrarRuta(${p.latitud},${p.longitud})'>Cómo llegar</button>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn google-btn">
                        <i class="fab fa-google"></i> Google Maps
                    </a>
                    <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank" class="popup-btn waze-btn">
                        <i class="fab fa-waze"></i> Waze
                    </a>
                </div>
                <div style='margin-top:10px;'>
                    <button class="fav-btn" data-id="${p.id}" data-nombre="${nombre}" data-lat="${lat}" data-lng="${lng}" title="Agregar a favoritos">
                        <i class="fa-regular fa-star"></i>
                    </button>
                </div>
            </div>
        `;

        if (!isNaN(lat) && !isNaN(lng)) {
            var marker = L.marker([lat, lng]).addTo(map).bindPopup(popupContent);
            marker.parqueaderoData = { nombre: nombre, direccion: direccion, ciudad: ciudad };
            markers.push(marker);
        }
    });

    window.mostrarRuta = function(destLat, destLng) {
        if (!userLatLng) {
            alert('Primero permite el acceso a tu ubicación.');
            return;
        }
        iniciarRouting(destLat, destLng);
    };

    // --- Filtro por búsqueda y ciudad ---
    function filtrarMarcadores() {
        var texto = document.getElementById('searchInput').value.toLowerCase();
        var ciudad = document.getElementById('citySelect').value;

        markers.forEach(function(marker) {
            var coincide = (
                (!ciudad || marker.parqueaderoData.ciudad === ciudad) &&
                (marker.parqueaderoData.nombre.toLowerCase().includes(texto) ||
                 marker.parqueaderoData.direccion.toLowerCase().includes(texto))
            );
            if (coincide) {
                map.addLayer(marker);
            } else {
                map.removeLayer(marker);
            }
        });
    }

    document.getElementById('searchInput').addEventListener('input', filtrarMarcadores);
    document.getElementById('citySelect').addEventListener('change', filtrarMarcadores);

    document.getElementById('center-location-btn').addEventListener('click', function() {
        if (userLatLng) {
            map.setView([userLatLng.lat, userLatLng.lng], 16, {animate:true});
        } else {
            alert('Ubicación no disponible aún.');
        }
    });

    // --- Favoritos ---
    function getFavoritos() {
        return JSON.parse(localStorage.getItem('parqueaderosFavoritos') || '[]');
    }
    function setFavoritos(favs) {
        localStorage.setItem('parqueaderosFavoritos', JSON.stringify(favs));
    }
    function toggleFavorito(id, nombre, lat, lng, btn) {
        let favs = getFavoritos();
        const idx = favs.findIndex(f => f.id == id);
        if (idx === -1) {
            favs.push({id, nombre, lat, lng});
            btn.querySelector('i').classList.remove('fa-regular');
            btn.querySelector('i').classList.add('fa-solid');
            btn.title = 'Quitar de favoritos';
        } else {
            favs.splice(idx, 1);
            btn.querySelector('i').classList.remove('fa-solid');
            btn.querySelector('i').classList.add('fa-regular');
            btn.title = 'Agregar a favoritos';
        }
        setFavoritos(favs);
        renderFavoritosList();
    }
    function renderFavoritosList() {
        let favs = getFavoritos();
        let cont = document.getElementById('favoritos-list');
        if (!cont) return;
        if (favs.length === 0) {
            cont.innerHTML = '<div style="color:#888;text-align:center;">No tienes favoritos aún.</div>';
            return;
        }
        cont.innerHTML = favs.map(f =>
            `<div class='fav-item' style='display:flex;align-items:center;gap:8px;margin-bottom:8px;'>
                <i class='fa-solid fa-star' style='color:#FFD700;'></i>
                <span style='font-weight:600;'>${f.nombre}</span>
                <button class='popup-btn llegar-btn' style='padding:4px 10px;font-size:0.95em;' onclick='window.mostrarRuta(${f.lat},${f.lng})'>Cómo llegar</button>
            </div>`
        ).join('');
    }
    window.addEventListener('click', function(e) {
        if (e.target.closest('.fav-btn')) {
            const btn = e.target.closest('.fav-btn');
            toggleFavorito(
                btn.getAttribute('data-id'),
                btn.getAttribute('data-nombre'),
                btn.getAttribute('data-lat'),
                btn.getAttribute('data-lng'),
                btn
            );
        }
    });
    // Marcar favoritos en popups al abrir
    map.on('popupopen', function(e) {
        const btn = e.popup._contentNode.querySelector('.fav-btn');
        if (!btn) return;
        let favs = getFavoritos();
        const isFav = favs.some(f => f.id == btn.getAttribute('data-id'));
        btn.querySelector('i').classList.toggle('fa-solid', isFav);
        btn.querySelector('i').classList.toggle('fa-regular', !isFav);
        btn.title = isFav ? 'Quitar de favoritos' : 'Agregar a favoritos';
    });
    // Render favoritos al cargar
    document.addEventListener('DOMContentLoaded', renderFavoritosList);
});
</script>
<div id="favoritos-list" style="max-width:600px;margin:24px auto 0 auto;padding:14px 18px 10px 18px;background:#fffbe6;border-radius:14px;box-shadow:0 2px 12px #b8860b22;font-size:1.08rem;color:#222;"></div>
<style>
@media (max-width: 600px) {
    #center-location-btn {
        width: 44px !important;
        height: 44px !important;
    }
    #center-location-btn span {
        font-size: 0.75rem !important;
    }
    .buscador-container h2 {
        font-size: 1.2rem !important;
    }
}
.popup-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 7px 15px;
    border-radius: 10px;
    font-size: 1.01em;
    font-weight: 700;
    border: none;
    outline: none;
    cursor: pointer;
    transition: background .18s, color .18s, box-shadow .18s;
    box-shadow: 0 2px 8px #0001;
    text-decoration: none !important;
    margin: 0 2px;
}
.popup-btn.reservar-btn {
    background: linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);
    color: #fff;
    border: 1.5px solid #43a047;
}
.popup-btn.reservar-btn:hover {
    background: linear-gradient(90deg,#43a047 0%,#2196f3 100%);
    color: #fff;
}
.popup-btn.llegar-btn {
    background: linear-gradient(90deg,#2196f3 0%,#21cbf3 100%);
    color: #fff;
    border: 1.5px solid #2196f3;
}
.popup-btn.llegar-btn:hover {
    background: linear-gradient(90deg,#1976d2 0%,#43e97b 100%);
    color: #fff;
}
.popup-btn.google-btn {
    background: #fff;
    color: #ea4335;
    border: 1.5px solid #ea4335;
}
.popup-btn.google-btn:hover {
    background: #ea4335;
    color: #fff;
}
.popup-btn.waze-btn {
    background: #fff;
    color: #0058e9;
    border: 1.5px solid #0058e9;
}
.popup-btn.waze-btn:hover {
    background: #0058e9;
    color: #fff;
}
.fav-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.3em;
    color: #FFD700;
    transition: transform .15s;
    margin: 0 auto;
    display: inline-block;
}
.fav-btn:hover {
    transform: scale(1.18);
    color: #ffb300;
}
.fav-item .llegar-btn {
    margin-left: auto;
}
</style>
{% endblock %}
