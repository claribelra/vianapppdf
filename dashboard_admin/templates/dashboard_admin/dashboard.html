{% load static %}
{% load dashboard_admin_extras %}
{% block content %}
<link rel="stylesheet" href="{% static 'dashboard_admin/stylesadmin.css' %}">
<div class="dashboard-admin-layout">
    <!-- Botón hamburguesa para móvil/tablet -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Mostrar menú">
        <span></span><span></span><span></span>
    </button>
    <aside class="sidebar-admin" id="sidebarAdmin">
        <div class="sidebar-logo">VIANApp Admin</div>
        <nav class="sidebar-nav">
            <a href="/dashboard/" class="sidebar-link">Inicio</a>
            <a href="/dashboard/usuarios/" class="sidebar-link{% if section == 'usuarios' %} active{% endif %}">Usuarios</a>
            <a href="/dashboard/parqueaderos/" class="sidebar-link{% if section == 'parqueaderos' %} active{% endif %}">Parqueaderos</a>
            <a href="/dashboard/comentarios/" class="sidebar-link{% if section == 'comentarios' %} active{% endif %}"><i class="fas fa-comments"></i> Comentarios</a>
        </nav>
        <div style="margin: 32px 0 0 0; text-align: center;">
            <a href="/" class="btn-volver-landing">Volver a Landing Page</a>
        </div>
    </aside>
    <main class="dashboard-content">
        {% if section == 'usuarios' %}
            <h1>Usuarios registrados</h1>
            <div class="usuarios-table-container">
                <table class="usuarios-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in usuarios %}
                        <tr>
                            <td>{{ u.profile.nombres }} {{ u.profile.apellidos }}</td>
                            <td>{{ u.email }}</td>
                            <td>{{ u.profile.rol|title }}</td>
                            <td>
                                {% if u.is_active %}
                                    <span class="estado-activo">Activo</span>
                                {% else %}
                                    <span class="estado-inactivo">Inactivo</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="/dashboard/usuarios/toggle/{{ u.id }}/" style="display:inline;">
                                    {% csrf_token %}
                                    {% if u.is_active %}
                                        <button type="submit" class="btn-desactivar">Desactivar</button>
                                    {% else %}
                                        <button type="submit" class="btn-activar">Activar</button>
                                    {% endif %}
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elif section == 'parqueaderos' %}
            <h1>Parqueaderos registrados</h1>
            <div class="usuarios-table-container">
                <table class="usuarios-table">
                    <thead>
                        <tr>
                            <th>Foto parqueadero</th>
                            <th>Foto propietario</th>
                            <th>Nombre comercial</th>
                            <th>Dirección</th>
                            <th>Ciudad</th>
                            <th>Teléfono</th>
                            <th>Propietario</th>
                            <th>Email</th>
                            <th>Espacios</th>
                            <th>Estado usuario</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in parqueaderos %}
                        <tr>
                            <td>
                                {% if p.foto_parqueadero %}
                                    <img src="{{ p.foto_parqueadero.url }}" alt="Foto parqueadero" style="width:70px;height:50px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px #2196f322;">
                                {% else %}
                                    <span style="color:#888;">Sin foto</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if p.foto_dueno %}
                                    <img src="{{ p.foto_dueno.url }}" alt="Foto dueño" style="width:50px;height:50px;object-fit:cover;border-radius:50%;box-shadow:0 2px 8px #2196f322;">
                                {% else %}
                                    <span style="color:#888;">Sin foto</span>
                                {% endif %}
                            </td>
                            <td>{{ p.nombre_comercial }}</td>
                            <td>{{ p.direccion }}</td>
                            <td>{{ p.ciudad|default:'-' }}</td>
                            <td>{{ p.telefono }}</td>
                            <td>{{ p.nombre_dueno }}</td>
                            <td>{{ p.email }}</td>
                            <td>{{ p.espacios }}</td>
                            <td>
                                {% with user=usuarios|get_user_by_email:p.email %}
                                    {% if user and user.is_active %}
                                        <span class="estado-activo">Activo</span>
                                    {% else %}
                                        <span class="estado-inactivo">Inactivo</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elif section == 'comentarios' %}
            <h1 style="text-align:center;font-size:2.3rem;font-weight:900;color:#0047b3;margin-bottom:32px;">Comentarios de Parqueaderos</h1>
            <div class="comentarios-table-container" style="max-width:600px;margin:0 auto;">
                <table class="comentarios-table" style="width:100%;background:#fff;border-radius:14px;box-shadow:0 2px 12px #2196f322;">
                    <thead>
                        <tr style="font-size:1.15rem;">
                            <th style="padding:12px 0 12px 12px;text-align:left;">Parqueadero</th>
                            <th style="text-align:center;">Ver comentarios</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in parqueaderos %}
                        <tr>
                            <td style="padding:10px 0 10px 12px;">{{ p.nombre_comercial|default:p.direccion }}</td>
                            <td style="text-align:center;">
                                <a href="{% url 'dashboard_comentarios_parqueadero' p.id %}" class="btn-ver-comentarios" title="Ver comentarios" style="color:#2196f3;font-size:1.3rem;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;background:#e3f0ff;border-radius:50%;transition:background 0.2s;box-shadow:0 1px 4px #2196f322;">
                                    <i class="fas fa-eye" style="color:#1565c0;font-size:1.3rem;"></i>Ver
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% elif section == 'ver_comentarios' %}
            <h1 style="text-align:center;font-size:2.1rem;font-weight:900;color:#0047b3;margin-bottom:24px;">Comentarios de {{ parqueadero.nombre_comercial|default:parqueadero.direccion }}</h1>
            <div class="comentarios-list-admin" style="max-width:600px;margin:0 auto;">
                {% for v in valoraciones %}
                <div class="comentario-admin-item" style="background:#fffbe6;border-radius:12px;padding:14px 18px;margin-bottom:14px;box-shadow:0 2px 8px #b8860b22;display:flex;align-items:center;gap:12px;">
                    <span class="comentario-estrellas" style="color:#FFD700;font-size:1.3rem;min-width:110px;">
                        {% for i in "12345"|slice:":v.rating" %}&#9733;{% endfor %}{% for i in "12345"|slice:"v.rating:" %}&#9734;{% endfor %}
                    </span>
                    <span class="comentario-texto" style="flex:1;font-size:1.08rem;">{{ v.comentario|linebreaksbr }}</span>
                    <span class="comentario-autor" style="font-size:0.98rem;color:#888;min-width:90px;">— {{ v.usuario.username }}</span>
                    <form method="post" action="{% url 'dashboard_eliminar_comentario' parqueadero.id v.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-eliminar-comentario" style="background:#fff;border:2px solid #b71c1c;color:#b71c1c;font-size:1.2rem;cursor:pointer;padding:6px 10px;border-radius:8px;transition:background 0.2s;"
                            onmouseover="this.style.background='#ffeaea'" onmouseout="this.style.background='#fff'"
                            onclick="return confirm('¿Eliminar este comentario?')">
                            <i class="fas fa-trash" style="color:#b71c1c;"></i>eliminar
                        </button>
                    </form>
                </div>
                {% empty %}
                <div class="text-muted" style="text-align:center;">No hay comentarios para este parqueadero.</div>
                {% endfor %}
                <div style="text-align:center;margin-top:18px;">
                    <a href="{% url 'dashboard_comentarios' %}" class="btn-volver-comentarios" style="background:#2196f3;color:#fff;padding:8px 22px;border-radius:8px;font-weight:600;text-decoration:none;">Volver a lista de parqueaderos</a>
                </div>
            </div>
        {% else %}
            <h1>Panel de Administración</h1>
            <p>Bienvenido al panel de administración de VIANApp.</p>
        {% endif %}
    </main>
</div>
<!-- Script para toggle sidebar -->
<script>
    const sidebar = document.getElementById('sidebarAdmin');
    const toggleBtn = document.getElementById('sidebarToggle');
    toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-collapsed');
        document.body.classList.toggle('sidebar-open');
    });
    // Cerrar sidebar al hacer click fuera en móvil
    document.addEventListener('click', function(e) {
        if(window.innerWidth <= 900 && document.body.classList.contains('sidebar-open')) {
            if(!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                sidebar.classList.remove('sidebar-collapsed');
                document.body.classList.remove('sidebar-open');
            }
        }
    });
</script>
{% endblock %}
